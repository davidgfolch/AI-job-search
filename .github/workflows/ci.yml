# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Madrid
    strategy:
      fail-fast: false
      matrix:
        module: [apps/commonlib, apps/scrapper, apps/aiEnrich, apps/aiEnrichNew, apps/aiEnrich3, apps/aiCvMatcher, apps/backend, apps/web]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          
      - name: Install global tools
        run: |
          cp 'scripts/.env.example' .env
          curl -LsSf https://astral.sh/uv/install.sh | sh
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install and Test ${{ matrix.module }}
        run: |
          MODULE="${{ matrix.module }}"
          SAFE_MODULE="${MODULE//\//-}"
          echo "ARTIFACT_NAME=badge-${SAFE_MODULE}" >> $GITHUB_ENV
          
          cd "${MODULE}"
          
          if [ -f "package.json" ]; then
            npm install
            npm test -- run --coverage
            npx coverage-badges --label "${MODULE}"
            mkdir -p coverage_artifacts
            cp coverage/badges.svg coverage_artifacts/coverage.svg
          elif [ "${MODULE}" == "apps/aiEnrich" ]; then
            uv tool update-shell
            uv tool install crewai
            crewai install
            uv run coverage run -m pytest
            uv run coverage report -m
            uv run coverage xml
            uv run genbadge coverage -i coverage.xml -o coverage.svg -n "${MODULE}"
          elif [ "${MODULE}" == "apps/backend" ] || [ "${MODULE}" == "apps/aiEnrichNew" ] || [ "${MODULE}" == "apps/aiEnrich3" ] || [ "${MODULE}" == "apps/aiCvMatcher" ]; then
            uv sync
            uv run coverage run -m pytest
            uv run coverage report -m
            uv run coverage xml
            uv run genbadge coverage -i coverage.xml -o coverage.svg -n "${MODULE}"
          else
            # apps/commonlib, apps/scrapper
            poetry lock
            poetry install --no-interaction
            poetry run coverage run -m pytest
            poetry run coverage report -m
            poetry run coverage xml
            poetry run genbadge coverage -i coverage.xml -o coverage.svg -n "${MODULE}"
          fi
          
      - name: Upload coverage badge
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            ${{ matrix.module }}/coverage.svg
            ${{ matrix.module }}/coverage_artifacts/coverage.svg

  update-badges:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && success()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all badges
        uses: actions/download-artifact@v4
        with:
          path: /tmp/badges

      - name: Commit coverage badges
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          changes=false
          MODULES="apps/commonlib apps/scrapper apps/aiEnrich apps/aiEnrichNew apps/aiEnrich3 apps/aiCvMatcher apps/backend apps/web"
          read -ra MODULE_ARR <<< "${MODULES}"
          
          for MODULE in "${MODULE_ARR[@]}"; do
            echo "Processing $MODULE"
            
            # Construct artifact name using same logic as test job
            SAFE_MODULE="${MODULE//\//-}"
            ARTIFACT_NAME="badge-${SAFE_MODULE}"
            
            # Define where the badge should go in the repo
            if [ "$MODULE" == "apps/web" ]; then
                TARGET_PATH="${MODULE}/coverage/badges.svg"
            else
                TARGET_PATH="${MODULE}/coverage.svg"
            fi
            
            # Find the downloaded badge
            # Search recursively within the artifact directory because upload-artifact v4 might preserve directory structure
            SOURCE_PATH=$(find "/tmp/badges/${ARTIFACT_NAME}" -name "coverage.svg" -type f | head -n 1)
            
            if [ -n "$SOURCE_PATH" ]; then
              echo "Found new badge at $SOURCE_PATH"
              
              # Ensure directory exists
              mkdir -p "$(dirname "$TARGET_PATH")"
              
              # Copy new badge
              cp "$SOURCE_PATH" "$TARGET_PATH"
              
              if git diff --quiet "$TARGET_PATH"; then
                echo "No changes for $MODULE"
              else
                 echo "Changes detected for $MODULE"
                 git add "$TARGET_PATH"
                 changes=true
              fi
            else
               echo "No badge found for $MODULE in /tmp/badges/${ARTIFACT_NAME}"
               ls -R "/tmp/badges/${ARTIFACT_NAME}" || true
            fi
          done
          
          if $changes; then
            git commit -m "Update coverage badges"
            # Xtheirs ignore conflicts keeping this commit version
            git pull --rebase -Xtheirs
            git push
          else
            echo "No coverage badge files changed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
